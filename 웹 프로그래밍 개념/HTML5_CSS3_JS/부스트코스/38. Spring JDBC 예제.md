# 38. Spring JDBC 예제

#### [개발전 알아야 되는 개념들]

---

1. **DTO**

   : Data Transfer Object의 약자

   : **계층(컨트롤러 뷰, 비지니스 계층, 퍼시스턴스 계층 의미)간 데이터 교환을 위한 자바빈즈**

   : 순수한 **데이터 객체**

   - DTO 예제

     : **필드와 getter, setter를 가진다**

     : 추가적으로 **toString(). equals(), hashCode()** 등의 Object 메소드 오버라이딩 가능

     ```java
     public class ActorDTO {
     	private Long id;
     	private String firstName;
     	private String lastName;
     	
     	public String getFirstName() {
     		return this.firstName;
     	}
     	public String getLastName() {
     		return this,lastName;
     	}
     	public Long getId() { ...
     	...
     }
     ```

   <br>

2. **DAO**

   :  Data Access Object의 약자

   : **데이터를 조회하거나 조작하는 기능을 전담하도록 만든 객체**

   : 보통 DB 조작 기능 전담 목적으로 만들어진다.

   <br>

3. **ConnectionPool**

   <img src="./images/38_1.jpg" style="zoom:67%;" />

   : 비싼 DB 연결 비용

   : 커넥션풀은 **미리 커넥션을 여러개 맺어 준다**

   : 커넥션 필요시 커넥션 풀에게 **빌려서 사용후 반납**

   : 반납 안하면 느려지거나 오류발생.

   <br>

4. **DataSource**

   : **커넥션 풀을 관리하는 목적**으로 사용되는 객체

   : 이를 통해 커넥션 얻어오고 반납하는 등의 작업을 수행

   <br>

#### [Spring JDBC를 이용한 DAO 개발]

---

- **Spring JDBC를 이용한 DAO 패턴 구조**

  ![](./images/38_2.png)

  - **ApplicationContext**

    : Spring 컨테이너. **설정 파일**. **ApplicationConfig 라는 클래스를 읽어들임**.

    : **DB Config 클래스를 import**

    <br>

  - **ApplicationConfig**

    : 컴포넌트 스캔 어노테이션이 DAO를 찾도록 설정

    : 이를 통해 **찾은 모든 DAO 클래스는 Spring 컨테이너(ApplicationContext)가 관리**힌다.

    <br>

  - **DBConfig**

    : dataSource와 transactionManager 객체를 생성

    <br>

  - **RoleDAO(DAO)**

    : 필드로 NamedParameterJdbcTemplate과 SimpleJdbcInsert를 가짐

    : 이 두 객체는 모두 **DataSource를 필요**로 한다. (DB 연결을 위해 내부적으로 DataSource를 사용)

    : **두 객체모두 SQL 실행 편리하게 하도록 Spring JDBC에서 제공하는 객체**

    : 이 두객체를 여기의 생성자에서 초기화하고 이를 이용해 RoleDao 메서드 구현

    <br>

  - **RoleDaoSqls**

    : **SQL 문을 상수로써 정의**해둠 (이후 SQL 변경되도 변경에 용이하게끔)

    <br>

  - **Role(DTO)**

    : **한건의 Role 정보를 저장, 전달 목적**으로 사용

<br>

#### [Spring JDBC를 이용한 DAO 개발 실전]

----

1. **maven 프로젝트 생성**

   : org,,, / maven-architect-quickstart 

   : 그룹 Id - kr.or.connect

   : 프로젝트명 - daoexam

   <br>

2. **pom.xml 에 라이브러리 추가**

   - Spring 사용 위한 spring-context 추가

     ```xml
     <!-- Spring -->
         <dependency>
         	<groupId>org.springframework</groupId>
         	<artifactId>spring-context</artifactId>
         	<version>${spring.version}</version>
         </dependency>
     ```

   - Spring JDBC 사용위한 spring-jdbc와 spring-tx 추가

     ```
     <!-- Spring JDBC-->
         <dependency>
         	<groupId>org.springframework</groupId>
         	<artifactId>spring-jdbc</artifactId>
         	<version>${spring.version}</version>
         </dependency>
         
         <dependency>
         	<groupId>org.springframework</groupId>
         	<artifactId>spring-tx</artifactId>
         	<version>${spring.version}</version>
         </dependency>
     ```

   - ${spring.version} 사용위한 프로퍼티 정보 추가

     ```
     <properties>
     	...
     	<spring.version>4.3.5.RELEASE</spring.version>
     </properties>
     ```

   - mysql 데이터베이스 사용위한 드라이버로 mysql-connector-java 추가

     ```
     <!-- mysql -->
         <dependency>
         	<groupId>mysql</groupId>
         	<artifactId>mysql-connector-java</artifactId>
         	<version>5.1.45</version>
         </dependency>
     ```

   - DataSource 사용위해 Apache에서 제공하는 commons-dbcp2 추가

     ```
     <!-- basic data source -->
     	<dependency>
     		<groupId>org.apache.commons</groupId>
     		<artifactId>commons-dbcp2</artifactId>
     		<version>2.1.1</version>
     	</dependency>
     ```

   <br>

3. **라이브러리 pom 작성후 Maven 프로젝트 업데이트**

   : 프로젝트 우클릭 - Maven - Update Project

   <br>

4. **앞서 보았던 Spring JDBC이용한 DAO 구조에서 만들어야하는 파일들 생성**

   - 패키지 생성

     : name - kr.or.connect.daoexam.config 인 설정파일용 패키지 생성

   - ApplicationConfig 클래스 생성

     : Spring이 만들어주는 ApplicationContext에게 어떤 설정들을 읽어들여 공장 만들지 알려주는 역할

     ```java
     package kr.or.connect.daoexam.config;
     
     import org.springframework.context.annotation.Configuration;
     import org.springframework.context.annotation.Import;
     
     @Configuration  // config 파일임을 알려주는 어노테이션
     @Import({DBConfig.class})       // 어노테이션 사용시 설정 파일 여러개로 나눠서 작성 가능(여기선 DBConfig 라는 파일에 데이터베이스 연결에 관련된 설정을 분리)
     public class ApplicationConfig {
     }
     ```

   - DBConfig 클래스 생성

     : 데이터베이스 설정만 따로 담고 있는 Config 클래스 (위에서 분리함)

     ```java
     package kr.or.connect.daoexam.config;
     
     import javax.sql.DataSource;
     import org.apache.commons.dbcp2.BasicDataSource;
     import org.springframework.context.annotation.Bean;
     import org.springframework.context.annotation.Configuration;
     import org.springframework.transaction.annotation.EnableTransactionManagement;
     
     @Configuration  // config 파일임을 알려주는 어노테이션
     @EnableTransactionManagement  // 다음강에서 다룸. 그냥 이 어노테이션은 트랜잭션때문에 필요하다는 것까지만 ㅇㅇ
     
     public class DBConfig {
     	// DB 연결위해 필요한 정보
     	private String driverClassName = "com.mysql.jdbc.Driver";
         private String url = "jdbc:mysql://localhost:3306/connectdb?useUnicode=true&characterEncoding=utf8";
     
         private String username = "connectuser";
         private String password = "connect123!@#";
         
         // DB에 접속하는 부분을 얻어내기위한 DataSource 생성해주는 클래스
         @Bean
         public DataSource dataSource() {  // 커넥션 관리해야하기 때문에 JDBC 드라이버, url, username, password등의 정보 필요
         	BasicDataSource dataSource = new BasicDataSource();
         	dataSource.setDriverClassName(driverClassName);
         	dataSource.setUrl(url);
         	dataSource.setUsername(username);
         	dataSource.setPassword(password);
         	return dataSource;
         }
     }
     ```

   - 작성후 DB 접속 여부 테스트 코드 (추가)

     ```java
     package kr.or.connect.daoexam.main;
     
     import java.sql.Connection;
     import javax.sql.DataSource;
     
     import org.springframework.context.ApplicationContext;
     import org.springframework.context.annotation.AnnotationConfigApplicationContext;
     
     import kr.or.connect.daoexam.config.ApplicationConfig;
     
     public class DataSourceTest { // DBConfig에서 DB 연결 이상 여부 확인 위한 클래스
     	public static void main(String[] args) {
     		// ApplicationConfig에서 어노테이션 정보 읽어오기 (저 Config 파일에선 DBConfig 파일 impot 했음)
     		ApplicationContext ac = new AnnotationConfigApplicationContext(ApplicationConfig.class);
     		DataSource ds = ac.getBean(DataSource.class);
     		Connection conn = null;
     		try {
     			conn = ds.getConnection();
     			if(conn != null) {
     				System.out.println("접속 성공");
     			}
     		} catch (Exception e) {
     			e.printStackTrace();
     		} finally {
     			if(conn != null) {
     				try {
     					conn.close();
     				} catch (Exception e) {
     					e.printStackTrace();
     				}
     			}
     		}
     	}
     
     }
     ```

   <br>

5. 

